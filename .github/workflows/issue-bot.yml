name: Outdated Version Check

on:
  issues:
    types: [opened, edited]

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            function compareVersions(a, b) {
              const pa = a.split('.').map(n => parseInt(n, 10) || 0);
              const pb = b.split('.').map(n => parseInt(n, 10) || 0);
              const len = Math.max(pa.length, pb.length);
              for (let i = 0; i < len; i++) {
                if ((pa[i] || 0) > (pb[i] || 0)) return 1;
                if ((pa[i] || 0) < (pb[i] || 0)) return -1;
              }
              return 0;
            }

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const body = issue.body || '';
            const match = body.match(/\*\*Version or Commit Hash\*\*\s*:?\s*([^\n\r]+)/i);
            if (!match) return;

            const reported = match[1].trim();
            const isCommit = /^[0-9a-fA-F]{7,40}$/.test(reported);

            const path = "src/main/java/com/opuadm/linuxifymc/LinuxifyMC.java";

            const getVersion = async (ref) => {
              try {
                const {data} = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path,
                  ref
                });
                const content = Buffer.from(data.content, "base64").toString();
                const m = content.match(/version\s*=\s*"([^"]+)"/i);
                return m ? m[1].replace(/^v/i, "") : null;
              } catch (e) {
                return null;
              }
            };

            let outdated = false;
            let msg = "";

            if (isCommit) {
              try {
                const {data: {commit: {sha: latestSha}}} = await github.rest.repos.getBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: "testing"
                });
                const lowerReported = reported.toLowerCase();
                const lowerLatest = latestSha.toLowerCase();
                const matches = lowerReported.length === 40 
                  ? lowerReported === lowerLatest 
                  : lowerLatest.startsWith(lowerReported);

                if (!matches) {
                  outdated = true;
                  const short = reported.length > 7 ? reported.slice(0,7) : reported;
                  msg = `Your commit \`${short}\` is outdated. Latest testing is \`${latestSha.slice(0,7)}\`.\nPlease pull latest testing branch and re-test.\nIssue stays open.`;
                }
              } catch (e) {}
            } else {
              const testingVer = await getVersion("testing");
              const mainVer = await getVersion("main");
              let releaseVer = null;
              try {
                const {data: releases} = await github.rest.repos.listReleases({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                if (releases[0]) releaseVer = await getVersion(releases[0].tag_name);
              } catch (e) {}

              const candidates = [testingVer, mainVer, releaseVer].filter(v => v && /^\d+\.\d/.test(v));
              if (candidates.length === 0) return;

              let latest = candidates[0];
              for (const v of candidates.slice(1)) {
                if (compareVersions(v, latest) > 0) latest = v;
              }

              const cleanReported = reported.replace(/^v/i, "");
              if (compareVersions(cleanReported, latest) < 0) {
                outdated = true;
                msg = `Your version \`${reported}\` is outdated. Latest is \`${latest}\`.\nPlease update to latest release or testing branch and re-test.\nIssue stays open.`;
              }
            }

            if (outdated) {
              const {data: comments} = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              const already = comments.some(c => c.user.login === "github-actions[bot]" && c.body.includes("outdated"));

              if (!already) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: msg
                });
              }
            }

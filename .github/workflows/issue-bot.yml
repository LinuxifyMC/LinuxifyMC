name: Outdated Version Check

on:
  issues:
    types: [opened, edited]

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const body = issue.body;
            if (!body) return;

            const match = body.match(/\*\*Version or Commit Hash\*\*[\s:]*([^\n\r]+)/i);
            if (!match) return;

            const reported = match[1].trim();
            const isCommit = /^[0-9a-fA-F]{40}$/.test(reported);

            const path = "src/main/java/com/opuadm/linuxifymc/LinuxifyMC.java";

            const getVersion = async (ref) => {
              try {
                const {data} = await github.rest.repos.getContent({owner: context.repo.owner, repo: context.repo.repo, path, ref});
                const content = Buffer.from(data.content, "base64").toString();
                const m = content.match(/public static String version = "([^"]+)";/);
                return m ? m[1].replace(/^v/i, "") : null;
              } catch { return null; }
            };

            let outdated = false;
            let msg = "";

            if (isCommit) {
              try {
                const {data: {commit: {sha: latestSha}}} = await github.rest.repos.getBranch({owner: context.repo.owner, repo: context.repo.repo, branch: "testing"});
                if (reported.toLowerCase() !== latestSha.toLowerCase()) {
                  outdated = true;
                  msg = `Your commit \`${reported.slice(0,7)}\` is outdated. Latest testing commit is \`${latestSha.slice(0,7)}\`.\nPlease pull latest testing branch and re-test.\nIssue stays open.`;
                }
              } catch {}
            } else {
              const testingVer = await getVersion("testing");
              const mainVer = await getVersion("main");
              let releaseVer = null;
              try {
                const {data: releases} = await github.rest.repos.listReleases({owner: context.repo.owner, repo: context.repo.repo});
                if (releases[0]) releaseVer = await getVersion(releases[0].tag_name);
              } catch {}

              const candidates = [testingVer, mainVer, releaseVer].filter(v => v && /^\d+\.\d+(\.\d+)?$/.test(v));
              if (!candidates.length) return;

              let latest = candidates.reduce((a, b) => a > b ? a : b);

              if (reported.replace(/^v/i, "") !== latest) {
                outdated = true;
                msg = `Your version \`${reported}\` is outdated. Latest version is \`${latest}\`.\nPlease update to latest release or testing branch and re-test.\nIssue stays open.`;
              }
            }

            if (outdated) {
              const {data: comments} = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              if (!comments.some(c => c.user.login === "github-actions[bot]" && c.body.includes("outdated"))) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: msg
                });
              }
            }
